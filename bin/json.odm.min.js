"use strict";function JsonOdm(){var t=this;this.sources={},this.selectedSource={},this.addSource=function(n,e,o){"object"==typeof e&&("undefined"==typeof t.sources[n]&&(t.sources[n]=e),o&&(t.selectedSource=e))},this.selectSource=function(n){"undefined"!=typeof t.sources[n]&&(t.selectedSource=t.sources[n])}}var root="undefined"!=typeof window?window:global,odm=new JsonOdm;root.jsonOdm||(root.jsonOdm=odm),"undefined"!=typeof module&&module.exports&&(module.exports=odm),jsonOdm.Util=function(){},jsonOdm.Util.prototype.isArray=function(t){return Array.isArray?Array.isArray(t):"[object Array]"===Object.prototype.toString.call(t)},jsonOdm.Util.prototype.is=function(t,n){n="string"==typeof n?[n]:n;var e=Object.prototype.toString.call(t);e=e.substring(8,e.length-1).toLowerCase();for(var o=0;o<n.length;o++){var r=n[o].toLowerCase();if("array"==r&&this.isArray(t))return!0;if(r==e)return!0;if(typeof t==r)return!0}return!1},jsonOdm.Util.prototype.objectKeys=Object.keys||function(){var t=Object.prototype.hasOwnProperty,n=!{toString:null}.propertyIsEnumerable("toString"),e=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],o=e.length;return function(r){if("object"!=typeof r&&("function"!=typeof r||null===r))throw new TypeError("Object.keys called on non-object");var u,i,s=[];for(u in r)t.call(r,u)&&s.push(u);if(n)for(i=0;o>i;i++)t.call(r,e[i])&&s.push(e[i]);return s}}(),jsonOdm.Util.prototype.branch=function(t,n){function e(){if(arguments&&arguments.length&&this){var t=this[arguments[0]];return t?e.apply(t,Array.prototype.slice.call(arguments,1)):t}return this}return e.apply(t,n)},jsonOdm.util=new jsonOdm.Util,jsonOdm.Geo=function(){},jsonOdm.Geo.pointWithinPolygon=function(t,n){if(!(jsonOdm.util.isArray(t)&&jsonOdm.util.isArray(n)&&n.length>2))return!1;var e=n[0][0]==n[n.length-1][0]&&n[0][1]==n[n.length-1][1],o=0;e||(n=n.concat([n[0]]));for(var r=0;r<n.length-1;r++)if(!(n[r][0]<t[0]&&n[r+1][0]<t[0]||n[r][1]<t[1]&&n[r+1][1]<t[1]||n[r][1]>t[1]&&n[r+1][1]>t[1])){var u=[n[r][0]-t[0],n[r][1]-t[1]],i=[n[r+1][0]-t[0],n[r+1][1]-t[1]];(u[0]-i[0])*(-u[1]/u[1]-i[1])+u[0]>=0&&o++}return o%2==1},jsonOdm.Collection=function(t){var n=Object.create(Array.prototype);return n=Array.apply(n)||n,"undefined"!=typeof t&&jsonOdm.selectedSource&&jsonOdm.selectedSource[t]&&(n=n.concat(jsonOdm.selectedSource[t])),jsonOdm.Collection.decorate(n),n.$branch=function(){var t=jsonOdm.util.branch(n,arguments);return jsonOdm.Collection.decorate(t),t},n},jsonOdm.Collection.decorate=function(t){var n=function(t){jsonOdm.util.isArray(t)&&(t.$hasMany=function(n,e,o,r){"string"==typeof o&&(r=r||o);var u=o;"string"==typeof o&&jsonOdm.selectedSource&&jsonOdm.selectedSource[o]&&(u=jsonOdm.selectedSource[o]);for(var i=0;i<t.length;i++){var s=n;if(t[i].hasOwnProperty(n)&&(s=t[i][n]),"undefined"==typeof t[i][r])for(var c=0;s.length&&c<s.length;c++){for(var l=null,f=0;f<u.length;f++)if(s[c]==u[f][e]){l=u[f];break}null!=l&&(t[i][r]||(t[i][r]=[]),t[i][r].push(l))}}},t.$hasOne=function(n,e,o,r){"string"==typeof o&&(r=r||o);var u=o;"string"==typeof o&&jsonOdm.selectedSource&&jsonOdm.selectedSource[o]&&(u=jsonOdm.selectedSource[o]);for(var i=0;i<t.length;i++){var s;if(t[i].hasOwnProperty(n)&&(s=t[i][n]),"undefined"==typeof t[i][r]){for(var c=null,l=0;l<u.length;l++)if(s==u[l][e]){c=u[l];break}null!=c&&(t[i][r]=c)}}},t.$query=function(){return new jsonOdm.Query(t)})};n(t)},jsonOdm.Query=function(t){this.$$commandQueue=[],this.$$collection=t},jsonOdm.Query.prototype.$delete=function(){if(this.$$commandQueue.length<1)return this;for(var t=0;t<this.$$collection.length;){for(var n=!0,e=0;e<this.$$commandQueue.length&&(n=n&&this.$$commandQueue[e](this.$$collection[t]));e++);n?this.$$collection.splice(t,1):t++}return this},jsonOdm.Query.prototype.$all=function(t){if(this.$$commandQueue.length<1)return this.$$collection;for(var n=new jsonOdm.Collection,e=0;e<this.$$collection.length;e++){for(var o=!0,r=0;r<this.$$commandQueue.length&&(o=o&&this.$$commandQueue[r](this.$$collection[e]));r++);if(o){if(t)return this.$$collection[e];n.push(this.$$collection[e])}}return n},jsonOdm.Query.prototype.$first=function(){return this.$all(!0)},jsonOdm.Query.prototype.$testCollection=function(t,n){var e=this.$$commandQueue.pop(),o=function(){return function(o){if(!(e instanceof jsonOdm.Collection||"function"==typeof e)||"function"!=typeof n)return!1;var r=e instanceof jsonOdm.Collection?e:e(o);return n(r,t)}}();return this.$$commandQueue.push(o),this},jsonOdm.Query.prototype.$binaryOperator=function(t,n){var e=function(t,e){return function(o){if("function"!=typeof e)return!1;for(var r=[],u=0;u<t.length;u++)for(var i=0;i<t[u].$$commandQueue.length;i++)r.push(t[u].$$commandQueue[i](o));return n(r)}}(t,n),o=new jsonOdm.Query(this.$$collection);return o.$$commandQueue.push(e),o},jsonOdm.Query.prototype.$branch=function(){var t=function(t){return function(n){return jsonOdm.util.branch(n,t)}}(arguments),n=new jsonOdm.Query(this.$$collection);return n.$$commandQueue.push(t),n},jsonOdm.Query.prototype.$eq=function(){return this.$testCollection(arguments,function(t,n){return Array.prototype.indexOf.call(n,t)>-1})},jsonOdm.Query.prototype.$in=function(t){return this.$testCollection(t,function(t,n){return Array.prototype.indexOf.call(n,t)>-1})},jsonOdm.Query.prototype.$ne=function(){return this.$testCollection(arguments,function(t,n){return-1==Array.prototype.indexOf.call(n,t)})},jsonOdm.Query.prototype.$nin=function(t){return this.$testCollection(t,function(t,n){return-1==Array.prototype.indexOf.call(n,t)})},jsonOdm.Query.prototype.$gt=function(t){return this.$testCollection(t,function(t,n){return t>n})},jsonOdm.Query.prototype.$gte=function(t){return this.$testCollection(t,function(t,n){return t>=n})},jsonOdm.Query.prototype.$lt=function(t){return this.$testCollection(t,function(t,n){return n>t})},jsonOdm.Query.prototype.$lte=function(t){return this.$testCollection(t,function(t,n){return n>=t})},jsonOdm.Query.prototype.$isNull=function(){return this.$testCollection(null,function(t){return"undefined"==typeof t||null===t})},jsonOdm.Query.prototype.$exists=function(){return this.$testCollection(null,function(t){return"undefined"!=typeof t})},jsonOdm.Query.prototype.$type=function(){return this.$testCollection(arguments,function(t,n){return jsonOdm.util.is(t,n)})},jsonOdm.Query.prototype.$mod=function(){return this.$testCollection(arguments,function(t,n){return t%n[0]==n[1]})},jsonOdm.Query.prototype.$regex=function(t,n){return this.$testCollection([t,n],function(t,n){var e=n[0];return"string"==typeof e&&(e="string"==typeof n[1]?new RegExp(e,n[1]):new RegExp(e)),e.test(t)})},jsonOdm.Query.prototype.$and=function(){return this.$binaryOperator(arguments,function(t){for(var n=0;n<t.length;n++)if(!t[n])return!1;return!0})},jsonOdm.Query.prototype.$nand=function(){return this.$binaryOperator(arguments,function(t){for(var n=0;n<t.length;n++)if(!t[n])return!0;return!1})},jsonOdm.Query.prototype.$not=jsonOdm.Query.prototype.$nand,jsonOdm.Query.prototype.$or=function(){return this.$binaryOperator(arguments,function(t){for(var n=0;n<t.length;n++)if(t[n])return!0;return!1})},jsonOdm.Query.prototype.$nor=function(){return this.$binaryOperator(arguments,function(t){for(var n=0;n<t.length;n++)if(t[n])return!1;return!0})};