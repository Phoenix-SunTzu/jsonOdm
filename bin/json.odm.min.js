"use strict";function JsonOdm(){var t=this;this.sources={},this.selectedSource={},this.addSource=function(n,o,e){"object"==typeof o&&("undefined"==typeof t.sources[n]&&(t.sources[n]=o),e&&(t.selectedSource=o))},this.selectSource=function(n){"undefined"!=typeof t.sources[n]&&(t.selectedSource=t.sources[n])}}var root="undefined"!=typeof window?window:global,odm=new JsonOdm;root.jsonOdm||(root.jsonOdm=odm),"undefined"!=typeof module&&module.exports&&(module.exports=odm),jsonOdm.Util=function(){},jsonOdm.Util.prototype.isArray=function(t){return Array.isArray?Array.isArray(t):"[object Array]"===Object.prototype.toString.call(t)},jsonOdm.Util.prototype.is=function(t,n){n="string"==typeof n?[n]:n;var o=Object.prototype.toString.call(t);o=o.substring(8,o.length-1).toLowerCase();for(var e=0;e<n.length;e++){var r=n[e].toLowerCase();if("array"==r&&this.isArray(t))return!0;if(r==o)return!0;if(typeof t==r)return!0}return!1},jsonOdm.Util.prototype.objectKeys=Object.keys||function(){var t=Object.prototype.hasOwnProperty,n=!{toString:null}.propertyIsEnumerable("toString"),o=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],e=o.length;return function(r){if("object"!=typeof r&&("function"!=typeof r||null===r))throw new TypeError("Object.keys called on non-object");var i,s,u=[];for(i in r)t.call(r,i)&&u.push(i);if(n)for(s=0;e>s;s++)t.call(r,o[s])&&u.push(o[s]);return u}}(),jsonOdm.Util.prototype.branch=function(t,n){function o(){if(arguments&&arguments.length&&this){var t=this[arguments[0]];return t?o.apply(t,Array.prototype.slice.call(arguments,1)):t}return this}return o.apply(t,n)},jsonOdm.util=new jsonOdm.Util,jsonOdm.Geo=function(){},jsonOdm.Geo.detectAsGeometry=function(t){if(!t.type)if(jsonOdm.util.isArray(t)&&2==t.length&&!jsonOdm.util.isArray(t[0]))t=new jsonOdm.Geo.Point(t);else if(jsonOdm.util.isArray(t)&&4==t.length&&!jsonOdm.util.isArray(t[0]))t=new jsonOdm.Geo.BoundaryBox(t);else if(jsonOdm.util.isArray(t)&&t.length>=1&&jsonOdm.util.isArray(t[0])&&2==t[0].length&&!jsonOdm.util.isArray(t[0][0]))t=new jsonOdm.Geo.LineString(t);else if(jsonOdm.util.isArray(t)&&t.length>=1&&jsonOdm.util.isArray(t[0])&&t[0].length>=1&&jsonOdm.util.isArray(t[0][0])&&2==t[0][0].length&&!jsonOdm.util.isArray(t[0][0][0]))t=new jsonOdm.Geo.Polygon(t);else{if(!(jsonOdm.util.isArray(t)&&t.length>=1&&jsonOdm.util.isArray(t[0])&&t[0].length>=1&&jsonOdm.util.isArray(t[0][0])&&t[0][0].length>=1&&jsonOdm.util.isArray(t[0][0][0])&&2==t[0][0][0].length)||jsonOdm.util.isArray(t[0][0][0][0]))return!1;t=new jsonOdm.Geo.MultiPolygon(t)}return t},jsonOdm.Geo.FeatureCollection=function(t,n){this.type="FeatureCollection",this.features=t||[],n&&(this.bbox=n)},jsonOdm.Geo.Feature=function(t,n,o,e){this.geometry=t||{},n&&(this.properties=n),o&&(this.bbox=o),e&&(this.id=e)},jsonOdm.Geo.BoundaryBox=function(t){var n=Object.create(Array.prototype);return n=Array.apply(n)||n,jsonOdm.util.isArray(t)?(n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3]):(n[0]=0,n[1]=0,n[2]=0,n[3]=0),n},jsonOdm.Geo.Point=function(t,n){this.type="Point",this.coordinates=t,n&&(this.bbox=n)},jsonOdm.Geo.Point.within=function(t,n){var o,e;if(!t.coordinates)return!1;if("Point"==n.type)return n.coordinates[0]==t.coordinates[0]&&n.coordinates[1]==t.coordinates[1];if("MultiPoint"==n.type||"LineString"==n.type){for(o=0;n.coordinates&&o<n.coordinates.length;o++)if(n.coordinates[o][0]==t.coordinates[0]&&n.coordinates[o][1]==t.coordinates[1])return!0;return!1}if("MultiLineString"==n.type){for(o=0;n.coordinates&&o<n.coordinates.length;o++)for(e=0;n.coordinates[o]&&e<n.coordinates[o].length;e++)if(n.coordinates[o][e][0]==t.coordinates[0]&&n.coordinates[o][e][1]==t.coordinates[1])return!0;return!1}if("Polygon"==n.type)return jsonOdm.Geo.pointWithinPolygon(t.coordinates,n.coordinates?n.coordinates[0]:null);if("MultiPolygon"==n.type){for(o=0;n.coordinates&&o<n.coordinates.length;o++)if(jsonOdm.Geo.pointWithinPolygon(t.coordinates,n.coordinates[o]?n.coordinates[o][0]:null))return!0;return!1}if("GeometryCollection"==n.type&&jsonOdm.util.isArray(n.geometries)){for(o=0;o<n.geometries.length;o++)if(jsonOdm.Geo.Point.within(t,n.geometries[o]))return!0;return!1}return jsonOdm.Geo.pointWithinBounds(t.coordinates,n)},jsonOdm.Geo.MultiPoint=function(t,n){this.type="MultiPoint",this.coordinates=t,n&&(this.bbox=n)},jsonOdm.Geo.MultiPoint.within=function(t,n){var o,e,r,i;if(!t.coordinates||!jsonOdm.util.isArray(t.coordinates))return!1;if("Point"==n.type)return 1==t.coordinates.length&&t.coordinates[0][0]==n.coordinates[0]&&t.coordinates[0][1]==n.coordinates[1];if("MultiPoint"==n.type){for(o=0;n.coordinates&&o<n.coordinates.length;o++){for(i=!1,e=0;t.coordinates&&e<t.coordinates.length;e++)i=i||n.coordinates[o][0]==t.coordinates[e][0]&&n.coordinates[o][1]==t.coordinates[e][1];if(!i)return!1}return!0}if("LineString"==n.type){for(r=0;t.coordinates&&r<t.coordinates.length;r++)if(!jsonOdm.Geo.pointWithinLineString(t.coordinates[r],n.coordinates))return!1;return!0}if("MultiLineString"==n.type){for(r=0;t.coordinates&&r<t.coordinates.length;r++){for(i=!1,o=0;n.coordinates&&o<n.coordinates.length;o++)if(jsonOdm.Geo.pointWithinLineString(t.coordinates[r],n.coordinates[o])){i=!0;break}if(!i)return!1}return!0}if("Polygon"==n.type){for(o=0;t.coordinates&&o<t.coordinates.length;o++)if(!jsonOdm.Geo.pointWithinPolygon(t.coordinates[o],n.coordinates?n.coordinates[0]:null))return!1;return!0}if("MultiPolygon"==n.type){for(e=0;t.coordinates&&e<t.coordinates.length;e++){for(i=!1,o=0;n.coordinates&&o<n.coordinates.length;o++)if(jsonOdm.Geo.pointWithinPolygon(t.coordinates[e],n.coordinates[o]?n.coordinates[o][0]:null)){i=!0;break}if(!i)return!1}return!0}if("GeometryCollection"==n.type&&jsonOdm.util.isArray(n.geometries)){for(o=0;o<n.geometries.length;o++)if(jsonOdm.Geo.MultiPoint.within(t,n.geometries[o]))return!0;return!1}for(o=0;o<t.coordinates.length;o++)if(!jsonOdm.Geo.pointWithinBounds(t.coordinates[o],n))return!1;return!0},jsonOdm.Geo.LineString=function(t,n){this.type="LineString",this.coordinates=t,n&&(this.bbox=n)},jsonOdm.Geo.LineString.within=function(t,n){var o,e;if(!t.coordinates||!jsonOdm.util.isArray(t.coordinates))return!1;if("Point"==n.type||"MultiPoint"==n.type)return!1;if("LineString"==n.type)return jsonOdm.Geo.lineStringWithinLineString(t.coordinates,n.coordinates);if("MultiLineString"==n.type){for(o=0;n.coordinates&&o<n.coordinates.length;o++)if(jsonOdm.Geo.lineStringWithinLineString(t.coordinates,n.coordinates[o]))return!0;return!1}if("Polygon"==n.type){for(o=0;t.coordinates&&o<t.coordinates.length;o++)if(!jsonOdm.Geo.pointWithinPolygon(t.coordinates[o],n.coordinates[0]))return!1;return!0}if("MultiPolygon"==n.type){for(o=0;n.coordinates&&o<n.coordinates.length;o++)for(e=0;t.coordinates&&e<t.coordinates.length;e++)if(jsonOdm.Geo.pointWithinPolygon(t.coordinates[e],n.coordinates[o][0])&&e+1==t.coordinates.length)return!0;return!1}if("GeometryCollection"==n.type&&jsonOdm.util.isArray(n.geometries)){for(o=0;o<n.geometries.length;o++)if(jsonOdm.Geo.LineString.within(t,n.geometries[o]))return!0;return!1}for(o=0;o<t.coordinates.length;o++)if(!jsonOdm.Geo.pointWithinBounds(t.coordinates[o],n))return!1;return!0},jsonOdm.Geo.MultiLineString=function(t,n){this.type="MultiLineString",this.coordinates=t,n&&(this.bbox=n)},jsonOdm.Geo.MultiLineString.within=function(t,n){var o,e,r,i;if(!t.coordinates||!jsonOdm.util.isArray(t.coordinates))return!1;if("Point"==n.type||"MultiPoint"==n.type)return!1;if("LineString"==n.type){for(o=0;t.coordinates&&o<t.coordinates.length;o++)if(!jsonOdm.Geo.lineStringWithinLineString(t.coordinates[o],n.coordinates))return!1;return!0}if("MultiLineString"==n.type){for(e=0;t.coordinates&&e<t.coordinates.length;e++){for(i=!1,o=0;n.coordinates&&o<n.coordinates.length;o++)if(jsonOdm.Geo.lineStringWithinLineString(t.coordinates[e],n.coordinates[o])){i=!0;break}if(!i)return!1}return!0}if("Polygon"==n.type){for(o=0;t.coordinates&&o<t.coordinates.length;o++)for(e=0;t.coordinates&&e<t.coordinates[o].length;e++)if(!jsonOdm.Geo.pointWithinPolygon(t.coordinates[o][e],n.coordinates[0]))return!1;return!0}if("MultiPolygon"==n.type){for(e=0;t.coordinates&&e<t.coordinates.length;e++){for(i=!1,o=0;n.coordinates&&o<n.coordinates.length;o++)for(r=0;t.coordinates[e]&&r<t.coordinates[e].length;r++)if(jsonOdm.Geo.pointWithinPolygon(t.coordinates[e][r],n.coordinates[o][0])&&r+1==t.coordinates[e].length){i=!0;break}if(!i)return!1}return!0}if("GeometryCollection"==n.type&&jsonOdm.util.isArray(n.geometries)){for(o=0;o<n.geometries.length;o++)if(jsonOdm.Geo.MultiLineString.within(t,n.geometries[o]))return!0;return!1}for(o=0;o<t.coordinates.length;o++)for(e=0;e<t.coordinates[o].length;e++)if(!jsonOdm.Geo.pointWithinBounds(t.coordinates[o][e],n))return!1;return!0},jsonOdm.Geo.Polygon=function(t,n){this.type="Polygon",this.coordinates=t,n&&(this.bbox=n)},jsonOdm.Geo.MultiPolygon=function(t,n){this.type="MultiPolygon",this.coordinates=t,n&&(this.bbox=n)},jsonOdm.Geo.GeometryCollection=function(t,n){this.type="GeometryCollection",this.geometries=t,n&&(this.bbox=n)},jsonOdm.Geo.pointWithinPolygon=function(t,n){if(!(jsonOdm.util.isArray(t)&&jsonOdm.util.isArray(n)&&n.length>2))return!1;var o=n[0][0]==n[n.length-1][0]&&n[0][1]==n[n.length-1][1],e=0;o||(n=n.concat([n[0]]));for(var r=0;r<n.length-1;r++){if(n[r][0]==t[0]&&n[r][1]==t[1])return!0;n[r][0]<t[0]&&n[r+1][0]<t[0]||n[r][1]<t[1]&&n[r+1][1]<t[1]||n[r][1]>t[1]&&n[r+1][1]>t[1]||(n[r][0]-n[r+1][0])*((t[1]-n[r+1][1])/(n[r][1]-n[r+1][1]))+n[r+1][0]>=t[1]&&e++}return e%2==1},jsonOdm.Geo.pointWithinLineString=function(t,n){if(!(jsonOdm.util.isArray(t)&&jsonOdm.util.isArray(n)&&n.length>=2))return!1;for(var o=0;o<n.length-1;o++)if((t[0]>=n[o][0]&&t[0]<=n[o+1][0]&&n[o][0]<=n[o+1][0]||t[0]<=n[o][0]&&t[0]>=n[o+1][0]&&n[o][0]>=n[o+1][0])&&(t[1]>=n[o][1]&&t[1]<=n[o+1][1]&&n[o][1]<=n[o+1][1]||t[1]<=n[o][1]&&t[1]>=n[o+1][1]&&n[o][1]>=n[o+1][1])&&(n[o][0]==t[0]&&n[o][1]==t[1]||n[o+1][0]==t[0]&&n[o+1][1]==t[1]||n[o][1]-n[o+1][1]!=0&&(n[o][0]-n[o+1][0])*((t[1]-n[o+1][1])/(n[o][1]-n[o+1][1]))+n[o+1][0]==t[0]||n[o][0]-n[o+1][0]!=0&&(n[o][1]-n[o+1][1])*((t[0]-n[o+1][0])/(n[o][0]-n[o+1][0]))+n[o+1][1]==t[1]))return!0;return!1},jsonOdm.Geo.pointWithinBounds=function(t,n){return jsonOdm.util.isArray(t)&&jsonOdm.util.isArray(n)&&4==n.length?t[0]>=n[0]&&t[1]>=n[1]&&t[0]<=n[2]&&t[1]<=n[3]:!1},jsonOdm.Geo.lineStringWithinLineString=function(t,n){if(!jsonOdm.util.isArray(t)||!jsonOdm.util.isArray(n))return!1;var o,e;for(o=0;t&&o<t.length;o++){var r=!1;for(e=0;n&&e<n.length;e++)if(t[o][0]==n[e][0]&&t[o][1]==n[e][1]){if(o+1==t.length)return!0;if(!(n[e+1]&&t[o+1][0]==n[e+1][0]&&t[o+1][1]==n[e+1][1]||t[o+1][0]==n[e][0]&&t[o+1][1]==n[e][1]||e>0&&t[o+1][0]==n[e-1][0]&&t[o+1][1]==n[e-1][1]))return!1;r=!0}if(!r)return!1}return!0},jsonOdm.Collection=function(t){var n=Object.create(Array.prototype);return n=Array.apply(n)||n,"undefined"!=typeof t&&jsonOdm.selectedSource&&jsonOdm.selectedSource[t]&&(n=n.concat(jsonOdm.selectedSource[t])),jsonOdm.Collection.decorate(n),n.$branch=function(){var t=jsonOdm.util.branch(n,arguments);return jsonOdm.Collection.decorate(t),t},n},jsonOdm.Collection.decorate=function(t){var n=function(t){jsonOdm.util.isArray(t)&&(t.$hasMany=function(n,o,e,r){"string"==typeof e&&(r=r||e);var i=e;"string"==typeof e&&jsonOdm.selectedSource&&jsonOdm.selectedSource[e]&&(i=jsonOdm.selectedSource[e]);for(var s=0;s<t.length;s++){var u=n;if(t[s].hasOwnProperty(n)&&(u=t[s][n]),"undefined"==typeof t[s][r])for(var c=0;u.length&&c<u.length;c++){for(var d=null,l=0;l<i.length;l++)if(u[c]==i[l][o]){d=i[l];break}null!=d&&(t[s][r]||(t[s][r]=[]),t[s][r].push(d))}}},t.$hasOne=function(n,o,e,r){"string"==typeof e&&(r=r||e);var i=e;"string"==typeof e&&jsonOdm.selectedSource&&jsonOdm.selectedSource[e]&&(i=jsonOdm.selectedSource[e]);for(var s=0;s<t.length;s++){var u;if(t[s].hasOwnProperty(n)&&(u=t[s][n]),"undefined"==typeof t[s][r]){for(var c=null,d=0;d<i.length;d++)if(u==i[d][o]){c=i[d];break}null!=c&&(t[s][r]=c)}}},t.$query=function(){return new jsonOdm.Query(t)})};n(t)},jsonOdm.Query=function(t){this.$$commandQueue=[],this.$$collection=t},jsonOdm.Query.prototype.$delete=function(){if(this.$$commandQueue.length<1)return this;for(var t=0;t<this.$$collection.length;){for(var n=!0,o=0;o<this.$$commandQueue.length&&(n=n&&this.$$commandQueue[o](this.$$collection[t]));o++);n?this.$$collection.splice(t,1):t++}return this},jsonOdm.Query.prototype.$all=function(t){if(this.$$commandQueue.length<1)return this.$$collection;for(var n=new jsonOdm.Collection,o=0;o<this.$$collection.length;o++){for(var e=!0,r=0;r<this.$$commandQueue.length&&(e=e&&this.$$commandQueue[r](this.$$collection[o]));r++);if(e){if(t)return this.$$collection[o];n.push(this.$$collection[o])}}return n},jsonOdm.Query.prototype.$first=function(){return this.$all(!0)},jsonOdm.Query.prototype.$testCollection=function(t,n){var o=this.$$commandQueue.pop(),e=function(){return function(e){if(!(o instanceof jsonOdm.Collection||"function"==typeof o)||"function"!=typeof n)return!1;var r=o instanceof jsonOdm.Collection?o:o(e);return n(r,t)}}();return this.$$commandQueue.push(e),this},jsonOdm.Query.prototype.$binaryOperator=function(t,n){var o=function(t,o){return function(e){if("function"!=typeof o)return!1;for(var r=[],i=0;i<t.length;i++)for(var s=0;s<t[i].$$commandQueue.length;s++)r.push(t[i].$$commandQueue[s](e));return n(r)}}(t,n),e=new jsonOdm.Query(this.$$collection);return e.$$commandQueue.push(o),e},jsonOdm.Query.prototype.$branch=function(){var t=function(t){return function(n){return jsonOdm.util.branch(n,t)}}(arguments),n=new jsonOdm.Query(this.$$collection);return n.$$commandQueue.push(t),n},jsonOdm.Query.prototype.$eq=function(){return this.$testCollection(arguments,function(t,n){return Array.prototype.indexOf.call(n,t)>-1})},jsonOdm.Query.prototype.$in=function(t){return this.$testCollection(t,function(t,n){return Array.prototype.indexOf.call(n,t)>-1})},jsonOdm.Query.prototype.$ne=function(){return this.$testCollection(arguments,function(t,n){return-1==Array.prototype.indexOf.call(n,t)})},jsonOdm.Query.prototype.$nin=function(t){return this.$testCollection(t,function(t,n){return-1==Array.prototype.indexOf.call(n,t)})},jsonOdm.Query.prototype.$gt=function(t){return this.$testCollection(t,function(t,n){return t>n})},jsonOdm.Query.prototype.$gte=function(t){return this.$testCollection(t,function(t,n){return t>=n})},jsonOdm.Query.prototype.$lt=function(t){return this.$testCollection(t,function(t,n){return n>t})},jsonOdm.Query.prototype.$lte=function(t){return this.$testCollection(t,function(t,n){return n>=t})},jsonOdm.Query.prototype.$isNull=function(){return this.$testCollection(null,function(t){return"undefined"==typeof t||null===t})},jsonOdm.Query.prototype.$exists=function(){return this.$testCollection(null,function(t){return"undefined"!=typeof t})},jsonOdm.Query.prototype.$type=function(){return this.$testCollection(arguments,function(t,n){return jsonOdm.util.is(t,n)})},jsonOdm.Query.prototype.$mod=function(){return this.$testCollection(arguments,function(t,n){return t%n[0]==n[1]})},jsonOdm.Query.prototype.$regex=function(t,n){return"string"==typeof t&&(t="string"==typeof n?new RegExp(t,n):new RegExp(t)),this.$testCollection(t,function(t,n){return n.test(t)})},jsonOdm.Query.prototype.$geoWithin=function(t){return this.$testCollection(jsonOdm.Geo.detectAsGeometry(t),function(t,n){return json.Geo[t.type]&&json.Geo[t.type].within&&json.Geo[t.type].within(t,n)})},jsonOdm.Query.prototype.$and=function(){return this.$binaryOperator(arguments,function(t){for(var n=0;n<t.length;n++)if(!t[n])return!1;return!0})},jsonOdm.Query.prototype.$nand=function(){return this.$binaryOperator(arguments,function(t){for(var n=0;n<t.length;n++)if(!t[n])return!0;return!1})},jsonOdm.Query.prototype.$not=jsonOdm.Query.prototype.$nand,jsonOdm.Query.prototype.$or=function(){return this.$binaryOperator(arguments,function(t){for(var n=0;n<t.length;n++)if(t[n])return!0;return!1})},jsonOdm.Query.prototype.$nor=function(){return this.$binaryOperator(arguments,function(t){for(var n=0;n<t.length;n++)if(t[n])return!1;return!0})};