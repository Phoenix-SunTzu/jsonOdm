"use strict";function JsonOdm(){var t=this;this.sources={},this.selectedSource={},this.addSource=function(e,n,o){"object"==typeof n&&("undefined"==typeof t.sources[e]&&(t.sources[e]=n),o&&(t.selectedSource=n))},this.selectSource=function(e){"undefined"!=typeof t.sources[e]&&(t.selectedSource=t.sources[e])}}var root="undefined"!=typeof window?window:global,odm=new JsonOdm;root.jsonOdm||(root.jsonOdm=odm),"undefined"!=typeof module&&module.exports&&(module.exports=odm),jsonOdm.util={isArray:function(t){return Array.isArray?Array.isArray(t):"[object Array]"===Object.prototype.toString.call(t)},objectKeys:Object.keys,branch:function(t,e){function n(){if(arguments&&arguments.length&&this){var t=this[arguments[0]];return t?n.apply(t,Array.prototype.slice.call(arguments,1)):t}return this}return n.apply(t,e)}},Object.keys||(jsonOdm.util.objectKeys=function(){var t=Object.prototype.hasOwnProperty,e=!{toString:null}.propertyIsEnumerable("toString"),n=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],o=n.length;return function(r){if("object"!=typeof r&&("function"!=typeof r||null===r))throw new TypeError("Object.keys called on non-object");var u,i,c=[];for(u in r)t.call(r,u)&&c.push(u);if(e)for(i=0;o>i;i++)t.call(r,n[i])&&c.push(n[i]);return c}}()),jsonOdm.Collection=function(t){var e=Object.create(Array.prototype);return e=Array.apply(e)||e,"undefined"!=typeof t&&jsonOdm.selectedSource&&jsonOdm.selectedSource[t]&&(e=e.concat(jsonOdm.selectedSource[t])),jsonOdm.Collection.decorate(e),e.$branch=function(){var t=jsonOdm.util.branch(e,arguments);return jsonOdm.Collection.decorate(t),t},e},jsonOdm.Collection.decorate=function(t){var e=function(t){jsonOdm.util.isArray(t)&&(t.$hasMany=function(e,n,o,r){"string"==typeof o&&(r=r||o);var u=o;"string"==typeof o&&jsonOdm.selectedSource&&jsonOdm.selectedSource[o]&&(u=jsonOdm.selectedSource[o]);for(var i=0;i<t.length;i++){var c=e;if(t[i].hasOwnProperty(e)&&(c=t[i][e]),"undefined"==typeof t[i][r])for(var s=0;c.length&&s<c.length;s++){for(var l=null,f=0;f<u.length;f++)if(c[s]==u[f][n]){l=u[f];break}null!=l&&(t[i][r]||(t[i][r]=[]),t[i][r].push(l))}}},t.$hasOne=function(e,n,o,r){"string"==typeof o&&(r=r||o);var u=o;"string"==typeof o&&jsonOdm.selectedSource&&jsonOdm.selectedSource[o]&&(u=jsonOdm.selectedSource[o]);for(var i=0;i<t.length;i++)if(t[i].hasOwnProperty(e)&&(e=t[i][e]),"undefined"==typeof t[i][r]){for(var c=null,s=0;s<u.length;s++)if(e==u[s][n]){c=u[s];break}null!=c&&(t[i][r]=c)}},t.$query=function(){return new jsonOdm.Query(t)})};e(t)},jsonOdm.Query=function(t){this.$$commandQueue=[],this.$$collection=t},jsonOdm.Query.prototype.$delete=function(){if(this.$$commandQueue.length<1)return this;for(var t=0;t<this.$$collection.length;){for(var e=!0,n=0;n<this.$$commandQueue.length&&(e=e&&this.$$commandQueue[n](this.$$collection[t]));n++);e?this.$$collection.splice(t,1):t++}return this},jsonOdm.Query.prototype.$all=function(t){if(this.$$commandQueue.length<1)return this.$$collection;for(var e=new jsonOdm.Collection,n=0;n<this.$$collection.length;n++){for(var o=!0,r=0;r<this.$$commandQueue.length&&(o=o&&this.$$commandQueue[r](this.$$collection[n]));r++);if(o){if(t)return this.$$collection[n];e.push(this.$$collection[n])}}return e},jsonOdm.Query.prototype.$first=function(){return this.$all(!0)},jsonOdm.Query.prototype.$testCollection=function(t,e){var n=this.$$commandQueue.pop(),o=function(){return function(o){if(!(n instanceof jsonOdm.Collection||"function"==typeof n)||"function"!=typeof e)return!1;var r=n instanceof jsonOdm.Collection?n:n(o);return e(r,t)}}();return this.$$commandQueue.push(o),this},jsonOdm.Query.prototype.$binaryOperator=function(t,e){var n=function(t,n){return function(o){if("function"!=typeof n)return!1;for(var r=[],u=0;u<t.length;u++)for(var i=0;i<t[u].$$commandQueue.length;i++)r.push(t[u].$$commandQueue[i](o));return e(r)}}(t,e),o=new jsonOdm.Query(this.$$collection);return o.$$commandQueue.push(n),o},jsonOdm.Query.prototype.$branch=function(){var t=function(t){return function(e){return jsonOdm.util.branch(e,t)}}(arguments),e=new jsonOdm.Query(this.$$collection);return e.$$commandQueue.push(t),e},jsonOdm.Query.prototype.$eq=function(){return this.$testCollection(arguments,function(t,e){return Array.prototype.indexOf.call(e,t)>-1})},jsonOdm.Query.prototype.$ne=function(){return this.$testCollection(arguments,function(t,e){return-1==Array.prototype.indexOf.call(e,t)})},jsonOdm.Query.prototype.$gt=function(t){return this.$testCollection(t,function(t,e){return t>e})},jsonOdm.Query.prototype.$gte=function(t){return this.$testCollection(t,function(t,e){return t>=e})},jsonOdm.Query.prototype.$lt=function(t){return this.$testCollection(t,function(t,e){return e>t})},jsonOdm.Query.prototype.$lte=function(t){return this.$testCollection(t,function(t,e){return e>=t})},jsonOdm.Query.prototype.$isNull=function(){return this.$testCollection(null,function(t){return"undefined"==typeof t||null===t})},jsonOdm.Query.prototype.$and=function(){return this.$binaryOperator(arguments,function(t){for(var e=0;e<t.length;e++)if(!t[e])return!1;return!0})},jsonOdm.Query.prototype.$or=function(){return this.$binaryOperator(arguments,function(t){for(var e=0;e<t.length;e++)if(t[e])return!0;return!1})};