"use strict";function JsonOdm(){var t=this;this.sources={},this.selectedSource={},this.addSource=function(o,n,e){"object"==typeof n&&("undefined"==typeof t.sources[o]&&(t.sources[o]=n),e&&(t.selectedSource=n))},this.selectSource=function(o){"undefined"!=typeof t.sources[o]&&(t.selectedSource=t.sources[o])}}var root="undefined"!=typeof window?window:global,odm=new JsonOdm;root.jsonOdm||(root.jsonOdm=odm),"undefined"!=typeof module&&module.exports&&(module.exports=odm),jsonOdm.Util=function(){},jsonOdm.Util.prototype.isArray=function(t){return Array.isArray?Array.isArray(t):"[object Array]"===Object.prototype.toString.call(t)},jsonOdm.Util.prototype.is=function(t,o){o="string"==typeof o?[o]:o;var n=Object.prototype.toString.call(t);n=n.substring(8,n.length-1).toLowerCase();for(var e=0;e<o.length;e++){var r=o[e].toLowerCase();if("array"==r&&this.isArray(t))return!0;if(r==n)return!0;if(typeof t==r)return!0}return!1},jsonOdm.Util.prototype.objectKeys=Object.keys||function(){var t=Object.prototype.hasOwnProperty,o=!{toString:null}.propertyIsEnumerable("toString"),n=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],e=n.length;return function(r){if("object"!=typeof r&&("function"!=typeof r||null===r))throw new TypeError("Object.keys called on non-object");var i,s,u=[];for(i in r)t.call(r,i)&&u.push(i);if(o)for(s=0;e>s;s++)t.call(r,n[s])&&u.push(n[s]);return u}}(),jsonOdm.Util.prototype.branch=function(t,o){function n(){if(arguments&&arguments.length&&this){var t=this[arguments[0]];return t?n.apply(t,Array.prototype.slice.call(arguments,1)):t}return this}return n.apply(t,o)},jsonOdm.util=new jsonOdm.Util,jsonOdm.Geo=function(){},jsonOdm.Geo.detectAsGeometry=function(t){if(!t.type)if(jsonOdm.util.isArray(t)&&2==t.length&&!jsonOdm.util.isArray(t[0]))t=new jsonOdm.Geo.Point(t);else if(jsonOdm.util.isArray(t)&&4==t.length&&!jsonOdm.util.isArray(t[0]))t=new jsonOdm.Geo.BoundaryBox(t);else if(jsonOdm.util.isArray(t)&&t.length>=1&&jsonOdm.util.isArray(t[0])&&2==t[0].length&&!jsonOdm.util.isArray(t[0][0]))t=new jsonOdm.Geo.LineString(t);else if(jsonOdm.util.isArray(t)&&t.length>=1&&jsonOdm.util.isArray(t[0])&&t[0].length>=1&&jsonOdm.util.isArray(t[0][0])&&2==t[0][0].length&&!jsonOdm.util.isArray(t[0][0][0]))t=new jsonOdm.Geo.Polygon(t);else{if(!(jsonOdm.util.isArray(t)&&t.length>=1&&jsonOdm.util.isArray(t[0])&&t[0].length>=1&&jsonOdm.util.isArray(t[0][0])&&t[0][0].length>=1&&jsonOdm.util.isArray(t[0][0][0])&&2==t[0][0][0].length)||jsonOdm.util.isArray(t[0][0][0]))return!1;t=new jsonOdm.Geo.MultiPolygon(t)}return t},jsonOdm.Geo.FeatureCollection=function(t,o){this.type="FeatureCollection",this.features=t||[],o&&(this.bbox=o)},jsonOdm.Geo.Feature=function(t,o,n,e){this.geometry=t||{},o&&(this.properties=o),n&&(this.bbox=n),e&&(this.id=e)},jsonOdm.Geo.BoundaryBox=function(t){var o=Object.create(Array.prototype);return o=Array.apply(o)||o,jsonOdm.util.isArray(t)?(o[0]=t[0],o[1]=t[1],o[2]=t[2],o[3]=t[3]):(o[0]=0,o[1]=0,o[2]=0,o[3]=0),o},jsonOdm.Geo.Point=function(t,o){this.type="Point",this.coordinates=t,o&&(this.bbox=o)},jsonOdm.Geo.Point.within=function(t,o){var n,e;if(!t.coordinates)return!1;if("Point"==o.type)return o.coordinates[0]==t.coordinates[0]&&o.coordinates[1]==t.coordinates[1];if("MultiPoint"==o.type||"LineString"==o.type){for(n=0;o.coordinates&&n<o.coordinates.length;n++)if(o.coordinates[n][0]==t.coordinates[0]&&o.coordinates[n][1]==t.coordinates[1])return!0;return!1}if("MultiLineString"==o.type){for(n=0;o.coordinates&&n<o.coordinates.length;n++)for(e=0;o.coordinates[n]&&e<o.coordinates[n].length;e++)if(o.coordinates[n][e][0]==t.coordinates[0]&&o.coordinates[n][e][1]==t.coordinates[1])return!0;return!1}if("Polygon"==o.type)return jsonOdm.Geo.pointWithinPolygon(t.coordinates,o.coordinates?o.coordinates[0]:null);if("MultiPolygon"==o.type){for(n=0;o.coordinates&&n<o.coordinates.length;n++)if(jsonOdm.Geo.pointWithinPolygon(t.coordinates,o.coordinates[n]?o.coordinates[n][0]:null))return!0;return!1}if("MultiGeometry"==o.type&&jsonOdm.util.isArray(o.geometries)){for(n=0;n<o.geometries.length;n++)if(jsonOdm.Geo.Point.within(t,o.geometries[n]))return!0;return!1}return!1},jsonOdm.Geo.MultiPoint=function(t,o){this.type="MultiPoint",this.coordinates=t,o&&(this.bbox=o)},jsonOdm.Geo.MultiPoint.within=function(t,o){var n,e,r,i;if(!point.coordinates)return!1;if("Point"==o.type)return!1;if("MultiPoint"==o.type||"LineString"==o.type){for(n=0;o.coordinates&&n<o.coordinates.length;n++){for(i=!1,e=0;t.coordinates&&e<t.coordinates.length;e++)i=i||o.coordinates[n][0]==t.coordinates[e][0]&&o.coordinates[n][1]==t.coordinates[e][1];if(!i)return!1}return!0}if("MultiLineString"==o.type){for(n=0;o.coordinates&&n<o.coordinates.length;n++){for(e=0;o.coordinates[n]&&e<o.coordinates[n].length;e++)i=!1;for(r=0;t.coordinates&&r<t.coordinates.length;r++)if(o.coordinates[n][e][0]==t.coordinates[r][0]&&o.coordinates[n][e][1]==t.coordinates[r][1]){i=!0;break}if(!i)return!1}return!1}if("Polygon"==o.type){for(n=0;t.coordinates&&n<t.coordinates.length;n++)if(!jsonOdm.Geo.pointWithinPolygon(t.coordinates[n],o.coordinates?o.coordinates[0]:null))return!1;return!0}if("MultiPolygon"==o.type){for(e=0;t.coordinates&&e<t.coordinates.length;e++){for(i=!1,n=0;o.coordinates&&n<o.coordinates.length;n++)if(jsonOdm.Geo.pointWithinPolygon(point.coordinates[e],o.coordinates[n]?o.coordinates[n][0]:null)){i=!0;break}if(!i)return!1}return!0}if("MultiGeometry"==o.type&&jsonOdm.util.isArray(o.geometries)){for(n=0;n<o.geometries.length;n++)if(jsonOdm.Geo.MultiPoint.within(t,o.geometries[n]))return!0;return!1}return!1},jsonOdm.Geo.LineString=function(t,o){this.type="LineString",this.coordinates=t,o&&(this.bbox=o)},jsonOdm.Geo.LineString.within=jsonOdm.Geo.MultiPoint.within,jsonOdm.Geo.MultiLineString=function(t,o){this.type="MultiLineString",this.coordinates=t,o&&(this.bbox=o)},jsonOdm.Geo.Polygon=function(t,o){this.type="Polygon",this.coordinates=t,o&&(this.bbox=o)},jsonOdm.Geo.MultiPolygon=function(t,o){this.type="MultiPolygon",this.coordinates=t,o&&(this.bbox=o)},jsonOdm.Geo.GeometryCollection=function(t,o){this.type="GeometryCollection",this.geometries=t,o&&(this.bbox=o)},jsonOdm.Geo.pointWithinPolygon=function(t,o){if(!(jsonOdm.util.isArray(t)&&jsonOdm.util.isArray(o)&&o.length>2))return!1;var n=o[0][0]==o[o.length-1][0]&&o[0][1]==o[o.length-1][1],e=0;n||(o=o.concat([o[0]]));for(var r=0;r<o.length-1;r++)if(!(o[r][0]<t[0]&&o[r+1][0]<t[0]||o[r][1]<t[1]&&o[r+1][1]<t[1]||o[r][1]>t[1]&&o[r+1][1]>t[1])){var i=[o[r][0]-t[0],o[r][1]-t[1]],s=[o[r+1][0]-t[0],o[r+1][1]-t[1]];(i[0]-s[0])*(-i[1]/i[1]-s[1])+i[0]>=0&&e++}return e%2==1},jsonOdm.Geo.pointWithinBounds=function(t,o){return jsonOdm.util.isArray(t)&&jsonOdm.util.isArray(o)&&4==o.length?t[0]>o[0]&&t[1]>o[1]&&t[0]<o[3]&&t[1]<o[4]:!1},jsonOdm.Collection=function(t){var o=Object.create(Array.prototype);return o=Array.apply(o)||o,"undefined"!=typeof t&&jsonOdm.selectedSource&&jsonOdm.selectedSource[t]&&(o=o.concat(jsonOdm.selectedSource[t])),jsonOdm.Collection.decorate(o),o.$branch=function(){var t=jsonOdm.util.branch(o,arguments);return jsonOdm.Collection.decorate(t),t},o},jsonOdm.Collection.decorate=function(t){var o=function(t){jsonOdm.util.isArray(t)&&(t.$hasMany=function(o,n,e,r){"string"==typeof e&&(r=r||e);var i=e;"string"==typeof e&&jsonOdm.selectedSource&&jsonOdm.selectedSource[e]&&(i=jsonOdm.selectedSource[e]);for(var s=0;s<t.length;s++){var u=o;if(t[s].hasOwnProperty(o)&&(u=t[s][o]),"undefined"==typeof t[s][r])for(var c=0;u.length&&c<u.length;c++){for(var l=null,d=0;d<i.length;d++)if(u[c]==i[d][n]){l=i[d];break}null!=l&&(t[s][r]||(t[s][r]=[]),t[s][r].push(l))}}},t.$hasOne=function(o,n,e,r){"string"==typeof e&&(r=r||e);var i=e;"string"==typeof e&&jsonOdm.selectedSource&&jsonOdm.selectedSource[e]&&(i=jsonOdm.selectedSource[e]);for(var s=0;s<t.length;s++){var u;if(t[s].hasOwnProperty(o)&&(u=t[s][o]),"undefined"==typeof t[s][r]){for(var c=null,l=0;l<i.length;l++)if(u==i[l][n]){c=i[l];break}null!=c&&(t[s][r]=c)}}},t.$query=function(){return new jsonOdm.Query(t)})};o(t)},jsonOdm.Query=function(t){this.$$commandQueue=[],this.$$collection=t},jsonOdm.Query.prototype.$delete=function(){if(this.$$commandQueue.length<1)return this;for(var t=0;t<this.$$collection.length;){for(var o=!0,n=0;n<this.$$commandQueue.length&&(o=o&&this.$$commandQueue[n](this.$$collection[t]));n++);o?this.$$collection.splice(t,1):t++}return this},jsonOdm.Query.prototype.$all=function(t){if(this.$$commandQueue.length<1)return this.$$collection;for(var o=new jsonOdm.Collection,n=0;n<this.$$collection.length;n++){for(var e=!0,r=0;r<this.$$commandQueue.length&&(e=e&&this.$$commandQueue[r](this.$$collection[n]));r++);if(e){if(t)return this.$$collection[n];o.push(this.$$collection[n])}}return o},jsonOdm.Query.prototype.$first=function(){return this.$all(!0)},jsonOdm.Query.prototype.$testCollection=function(t,o){var n=this.$$commandQueue.pop(),e=function(){return function(e){if(!(n instanceof jsonOdm.Collection||"function"==typeof n)||"function"!=typeof o)return!1;var r=n instanceof jsonOdm.Collection?n:n(e);return o(r,t)}}();return this.$$commandQueue.push(e),this},jsonOdm.Query.prototype.$binaryOperator=function(t,o){var n=function(t,n){return function(e){if("function"!=typeof n)return!1;for(var r=[],i=0;i<t.length;i++)for(var s=0;s<t[i].$$commandQueue.length;s++)r.push(t[i].$$commandQueue[s](e));return o(r)}}(t,o),e=new jsonOdm.Query(this.$$collection);return e.$$commandQueue.push(n),e},jsonOdm.Query.prototype.$branch=function(){var t=function(t){return function(o){return jsonOdm.util.branch(o,t)}}(arguments),o=new jsonOdm.Query(this.$$collection);return o.$$commandQueue.push(t),o},jsonOdm.Query.prototype.$eq=function(){return this.$testCollection(arguments,function(t,o){return Array.prototype.indexOf.call(o,t)>-1})},jsonOdm.Query.prototype.$in=function(t){return this.$testCollection(t,function(t,o){return Array.prototype.indexOf.call(o,t)>-1})},jsonOdm.Query.prototype.$ne=function(){return this.$testCollection(arguments,function(t,o){return-1==Array.prototype.indexOf.call(o,t)})},jsonOdm.Query.prototype.$nin=function(t){return this.$testCollection(t,function(t,o){return-1==Array.prototype.indexOf.call(o,t)})},jsonOdm.Query.prototype.$gt=function(t){return this.$testCollection(t,function(t,o){return t>o})},jsonOdm.Query.prototype.$gte=function(t){return this.$testCollection(t,function(t,o){return t>=o})},jsonOdm.Query.prototype.$lt=function(t){return this.$testCollection(t,function(t,o){return o>t})},jsonOdm.Query.prototype.$lte=function(t){return this.$testCollection(t,function(t,o){return o>=t})},jsonOdm.Query.prototype.$isNull=function(){return this.$testCollection(null,function(t){return"undefined"==typeof t||null===t})},jsonOdm.Query.prototype.$exists=function(){return this.$testCollection(null,function(t){return"undefined"!=typeof t})},jsonOdm.Query.prototype.$type=function(){return this.$testCollection(arguments,function(t,o){return jsonOdm.util.is(t,o)})},jsonOdm.Query.prototype.$mod=function(){return this.$testCollection(arguments,function(t,o){return t%o[0]==o[1]})},jsonOdm.Query.prototype.$regex=function(t,o){return"string"==typeof t&&(t="string"==typeof o?new RegExp(t,o):new RegExp(t)),this.$testCollection(t,function(t,o){return o.test(t)})},jsonOdm.Query.prototype.$geoWithin=function(t){return this.$testCollection(jsonOdm.Geo.detectAsGeometry(t),function(t,o){return json.Geo[t.type]&&json.Geo[t.type].within&&json.Geo[t.type].within(t,o)})},jsonOdm.Query.prototype.$and=function(){return this.$binaryOperator(arguments,function(t){for(var o=0;o<t.length;o++)if(!t[o])return!1;return!0})},jsonOdm.Query.prototype.$nand=function(){return this.$binaryOperator(arguments,function(t){for(var o=0;o<t.length;o++)if(!t[o])return!0;return!1})},jsonOdm.Query.prototype.$not=jsonOdm.Query.prototype.$nand,jsonOdm.Query.prototype.$or=function(){return this.$binaryOperator(arguments,function(t){for(var o=0;o<t.length;o++)if(t[o])return!0;return!1})},jsonOdm.Query.prototype.$nor=function(){return this.$binaryOperator(arguments,function(t){for(var o=0;o<t.length;o++)if(t[o])return!1;return!0})};