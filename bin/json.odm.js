"use strict";function JsonOdm(){var e=this;this.sources={},this.selectedSource={},this.addSource=function(n,t,r){"object"==typeof t&&("undefined"==typeof e.sources[n]&&(e.sources[n]=t),r&&(e.selectedSource=t))},this.selectSource=function(n){"undefined"!=typeof e.sources[n]&&(e.selectedSource=e.sources[n])}}window.jsonOdm||(window.jsonOdm=new JsonOdm),jsonOdm.util={isArray:function(e){return Array.isArray?Array.isArray(e):"[object Array]"===Object.prototype.toString.call(e)},objectKeys:Object.keys,branch:function(e,n){function t(){if(arguments&&arguments.length&&this){var e=this[arguments[0]];return e?t.apply(e,Array.prototype.slice.call(arguments,1)):!1}return this}return t.apply(e,n)}},Object.keys||(jsonOdm.util.objectKeys=function(){var e=Object.prototype.hasOwnProperty,n=!{toString:null}.propertyIsEnumerable("toString"),t=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],r=t.length;return function(o){if("object"!=typeof o&&("function"!=typeof o||null===o))throw new TypeError("Object.keys called on non-object");var u,c,s=[];for(u in o)e.call(o,u)&&s.push(u);if(n)for(c=0;r>c;c++)e.call(o,t[c])&&s.push(t[c]);return s}}()),jsonOdm.Collection=function(e){var n=Object.create(Array.prototype);return n=Array.apply(n,Array.prototype.slice.call(arguments,1))||n,"undefined"!=typeof e&&jsonOdm.selectedSource&&jsonOdm.selectedSource[e]&&(n=n.concat(jsonOdm.selectedSource[e])),jsonOdm.Collection.decorate(n),n.$branch=function(){var e=jsonOdm.util.branch(n,arguments);return jsonOdm.Collection.decorate(e),e},n},jsonOdm.Collection.decorate=function(e){var n=function(e){jsonOdm.util.isArray(e)&&(e.$hasMany=function(n,t,r,o){"string"==typeof r&&(o=o||r);var u=r;"string"==typeof r&&jsonOdm.selectedSource&&jsonOdm.selectedSource[r]&&(u=jsonOdm.selectedSource[r]);for(var c=0;c<e.length;c++){var s=n;if(e[c].hasOwnProperty(n)&&(s=e[c][n]),"undefined"==typeof e[c][o])for(var i=0;s.length&&i<s.length;i++){for(var a=null,l=0;l<u.length;l++)if(s[i]==u[l][t]){a=u[l];break}null!=a&&(e[c][o]||(e[c][o]=[]),e[c][o].push(a))}}},e.$hasOne=function(n,t,r,o){"string"==typeof r&&(o=o||r);var u=r;"string"==typeof r&&jsonOdm.selectedSource&&jsonOdm.selectedSource[r]&&(u=jsonOdm.selectedSource[r]);for(var c=0;c<e.length;c++)if(e[c].hasOwnProperty(n)&&(n=e[c][n]),"undefined"==typeof e[c][o]){for(var s=null,i=0;i<u.length;i++)if(n==u[i][t]){s=u[i];break}null!=s&&(e[c][o]=s)}},e.$query=function(){return new jsonOdm.Query(e)})};n(e)},jsonOdm.Query=function(e){this.$$commandQueue=[],this.$$collection=e,this.$all=function(n){if(this.$$commandQueue.length<1)return e;for(var t=new jsonOdm.Collection,r=0;r<e.length;r++){for(var o=!0,u=0;u<this.$$commandQueue.length&&(o=o&&this.$$commandQueue[u](e[r]));u++);if(o){if(n)return e[r];t.push(e[r])}}return t},this.$first=function(){return this.$all(!0)}},jsonOdm.Query.prototype.$testCollection=function(e,n){var t=this.$$commandQueue.pop(),r=function(){return function(r){if(!(t instanceof jsonOdm.Collection||"function"==typeof t)||"function"!=typeof n)return!1;var o=t instanceof jsonOdm.Collection?t:t(r);return n(o,e)}}();return this.$$commandQueue.push(r),this},jsonOdm.Query.prototype.$binaryOperator=function(e,n){var t=function(e,t){return function(r){if("function"!=typeof t)return!1;for(var o=[],u=0;u<e.length;u++)for(var c=0;c<e[u].$$commandQueue.length;c++)o.push(e[u].$$commandQueue[c](r));return n(o)}}(e,n),r=new jsonOdm.Query(this.$$collection);return r.$$commandQueue.push(t),r},jsonOdm.Query.prototype.$branch=function(){var e=function(e){return function(n){return jsonOdm.util.branch(n,e)}}(arguments),n=new jsonOdm.Query(this.$$collection);return n.$$commandQueue.push(e),n},jsonOdm.Query.prototype.$eq=function(){return this.$testCollection(arguments,function(e,n){return Array.prototype.indexOf.call(n,e)>-1})},jsonOdm.Query.prototype.$notEq=function(){return this.$testCollection(arguments,function(e,n){return-1==Array.prototype.indexOf.call(n,e)})},jsonOdm.Query.prototype.$and=function(){return this.$binaryOperator(arguments,function(e){for(var n=0;n<e.length;n++)if(!e[n])return!1;return!0})},jsonOdm.Query.prototype.$or=function(){return this.$binaryOperator(arguments,function(e){for(var n=0;n<e.length;n++)if(e[n])return!0;return!1})};